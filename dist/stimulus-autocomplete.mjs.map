{"version":3,"file":"stimulus-autocomplete.mjs","sources":["../src/autocomplete.mjs"],"sourcesContent":["import { Controller } from \"stimulus\"\nimport debounce from \"lodash.debounce\"\n\nexport default class extends Controller {\n  static targets = [\"input\", \"hidden\", \"results\"]\n  static values = {\n    submitOnEnter: Boolean,\n    url: String,\n    minLength: Number,\n    /*\n     * Should we skip adding/removing the \"hidden\" property from resultsTarget?\n     *\n     * If set, you must listen to the \"toggle\" event from this\n     * controller to manually show/hide the results target.\n     */\n    skipHiddenProperty: Boolean,\n  }\n\n  connect() {\n    this.close();\n\n    // chrome ignores autocomplete=off in favor of series of defined autocomplete values in their WHATWG standard\n    // https://bugs.chromium.org/p/chromium/issues/detail?id=468153#c164\n    this.inputTarget.hasAttribute(\"autocomplete\") || this.inputTarget.setAttribute(\"autocomplete\", \"off\")\n    this.inputTarget.setAttribute(\"spellcheck\", \"false\")\n\n    this.mouseDown = false\n\n    this.onInputChange = debounce(this.onInputChange.bind(this), 300)\n    this.onResultsClick = this.onResultsClick.bind(this)\n    this.onResultsMouseDown = this.onResultsMouseDown.bind(this)\n    this.onInputBlur = this.onInputBlur.bind(this)\n    this.onKeydown = this.onKeydown.bind(this)\n\n    this.inputTarget.addEventListener(\"keydown\", this.onKeydown)\n    this.inputTarget.addEventListener(\"blur\", this.onInputBlur)\n    this.inputTarget.addEventListener(\"input\", this.onInputChange)\n    this.resultsTarget.addEventListener(\"mousedown\", this.onResultsMouseDown)\n    this.resultsTarget.addEventListener(\"click\", this.onResultsClick)\n\n    if (typeof this.inputTarget.getAttribute(\"autofocus\") === \"string\") {\n      this.inputTarget.focus()\n    }\n  }\n\n  disconnect() {\n    if (this.hasInputTarget) {\n      this.inputTarget.removeEventListener(\"keydown\", this.onKeydown)\n      this.inputTarget.removeEventListener(\"focus\", this.onInputFocus)\n      this.inputTarget.removeEventListener(\"blur\", this.onInputBlur)\n      this.inputTarget.removeEventListener(\"input\", this.onInputChange)\n    }\n    if (this.hasResultsTarget) {\n      this.resultsTarget.removeEventListener(\n        \"mousedown\",\n        this.onResultsMouseDown\n      )\n      this.resultsTarget.removeEventListener(\"click\", this.onResultsClick)\n    }\n  }\n\n  sibling(next) {\n    const options = Array.from(\n      this.resultsTarget.querySelectorAll(\n        '[role=\"option\"]:not([aria-disabled])'\n      )\n    )\n    const selected = this.resultsTarget.querySelector('[aria-selected=\"true\"]')\n    const index = options.indexOf(selected)\n    const sibling = next ? options[index + 1] : options[index - 1]\n    const def = next ? options[0] : options[options.length - 1]\n    return sibling || def\n  }\n\n  select(target) {\n    for (const el of this.resultsTarget.querySelectorAll(\n      '[aria-selected=\"true\"]'\n    )) {\n      el.removeAttribute(\"aria-selected\")\n      el.classList.remove(\"active\")\n    }\n    target.setAttribute(\"aria-selected\", \"true\")\n    target.classList.add(\"active\")\n    this.inputTarget.setAttribute(\"aria-activedescendant\", target.id)\n    target.scrollIntoView(false)\n  }\n\n  onKeydown(event) {\n    switch (event.key) {\n      case \"Escape\":\n        if (!this.isHidden) {\n          this.hideAndRemoveOptions()\n          event.stopPropagation()\n          event.preventDefault()\n        }\n        break\n      case \"ArrowDown\":\n        {\n          const item = this.sibling(true)\n          if (item) this.select(item)\n          event.preventDefault()\n        }\n        break\n      case \"ArrowUp\":\n        {\n          const item = this.sibling(false)\n          if (item) this.select(item)\n          event.preventDefault()\n        }\n        break\n      case \"Tab\":\n        {\n          const selected = this.resultsTarget.querySelector(\n            '[aria-selected=\"true\"]'\n          )\n          if (selected) {\n            this.commit(selected)\n          }\n        }\n        break\n      case \"Enter\":\n        {\n          const selected = this.resultsTarget.querySelector(\n            '[aria-selected=\"true\"]'\n          )\n          if (selected && !this.isHidden) {\n            this.commit(selected)\n            if (!this.hasSubmitOnEnterValue) {\n              event.preventDefault()\n            }\n          }\n        }\n        break\n    }\n  }\n\n  onInputBlur() {\n    if (this.mouseDown) return\n    this.close();\n  }\n\n  commit(selected) {\n    if (selected.getAttribute(\"aria-disabled\") === \"true\") return\n\n    if (selected instanceof HTMLAnchorElement) {\n      selected.click()\n      this.close();\n      return\n    }\n\n    const textValue = this.extractTextValue(selected)\n    const value = selected.getAttribute(\"data-autocomplete-value\") || textValue\n    this.inputTarget.value = textValue\n\n    if (this.hasHiddenTarget) {\n      this.hiddenTarget.value = value\n      this.hiddenTarget.dispatchEvent(new Event(\"input\"))\n      this.hiddenTarget.dispatchEvent(new Event(\"change\"))\n    } else {\n      this.inputTarget.value = value\n    }\n\n    this.inputTarget.focus()\n    this.hideAndRemoveOptions()\n\n    this.element.dispatchEvent(\n      new CustomEvent(\"autocomplete.change\", {\n        bubbles: true,\n        detail: { value: value, textValue: textValue }\n      })\n    )\n  }\n\n  onResultsClick(event) {\n    if (!(event.target instanceof Element)) return\n    const selected = event.target.closest('[role=\"option\"]')\n    if (selected) this.commit(selected)\n  }\n\n  onResultsMouseDown() {\n    this.mouseDown = true\n    this.resultsTarget.addEventListener(\n      \"mouseup\",\n      () => (this.mouseDown = false),\n      { once: true }\n    )\n  }\n\n  onInputChange() {\n    this.element.removeAttribute(\"value\")\n    this.fetchResults()\n  }\n\n  identifyOptions() {\n    let id = 0\n    for (const el of this.resultsTarget.querySelectorAll(\n      '[role=\"option\"]:not([id])'\n    )) {\n      el.id = `${this.resultsTarget.id}-option-${id++}`\n    }\n  }\n\n  hideAndRemoveOptions() {\n    this.close();\n    this.resultsTarget.innerHTML = null\n  }\n\n  fetchResults() {\n    const query = this.inputTarget.value.trim()\n    if (!query || query.length < this.minLengthValue) {\n      this.hideAndRemoveOptions()\n      return\n    }\n\n    if (!this.hasUrlValue) return\n\n    const headers = { \"X-Requested-With\": \"XMLHttpRequest\" }\n    const url = new URL(this.urlValue, window.location.href)\n    const params = new URLSearchParams(url.search.slice(1))\n    params.append(\"q\", query)\n    url.search = params.toString()\n\n    this.element.dispatchEvent(new CustomEvent(\"loadstart\"))\n\n    fetch(url.toString(), { headers })\n      .then(response => response.text())\n      .then(html => {\n        this.resultsTarget.innerHTML = html\n        this.identifyOptions()\n        const hasResults = !!this.resultsTarget.querySelector('[role=\"option\"]')\n        if (hasResults) {\n          this.open();\n        } else {\n          this.close();\n        }\n        this.element.dispatchEvent(new CustomEvent(\"load\"))\n        this.element.dispatchEvent(new CustomEvent(\"loadend\"))\n      })\n      .catch(() => {\n        this.element.dispatchEvent(new CustomEvent(\"error\"))\n        this.element.dispatchEvent(new CustomEvent(\"loadend\"))\n      })\n  }\n\n  open() {\n    if (!this.isHidden) return\n    if (!this.hasSkipHiddenPropertyValue) {\n      this.resultsTarget.hidden = false\n    }\n    this.isHidden = false;\n    this.element.setAttribute(\"aria-expanded\", \"true\")\n    this.element.dispatchEvent(\n      new CustomEvent(\"toggle\", {\n        detail: { action: 'open', inputTarget: this.inputTarget, resultsTarget: this.resultsTarget }\n      })\n    )\n  }\n\n  close() {\n    if (this.isHidden) return\n    if (!this.hasSkipHiddenPropertyValue) {\n      this.resultsTarget.hidden = true\n    }\n    this.isHidden = true;\n    this.inputTarget.removeAttribute(\"aria-activedescendant\")\n    this.element.setAttribute(\"aria-expanded\", \"false\")\n    this.element.dispatchEvent(\n      new CustomEvent(\"toggle\", {\n        detail: { action: 'close', inputTarget: this.inputTarget, resultsTarget: this.resultsTarget }\n      })\n    )\n  }\n\n  extractTextValue = el =>\n    el.hasAttribute(\"data-autocomplete-label\")\n      ? el.getAttribute(\"data-autocomplete-label\")\n      : el.textContent.trim()\n}\n"],"names":["extractTextValue","el","hasAttribute","getAttribute","textContent","trim","connect","close","inputTarget","this","setAttribute","mouseDown","onInputChange","debounce","bind","onResultsClick","onResultsMouseDown","onInputBlur","onKeydown","addEventListener","resultsTarget","focus","disconnect","hasInputTarget","removeEventListener","onInputFocus","hasResultsTarget","sibling","next","options","Array","from","querySelectorAll","selected","querySelector","index","indexOf","length","select","target","const","removeAttribute","classList","remove","add","id","scrollIntoView","event","key","isHidden","hideAndRemoveOptions","stopPropagation","preventDefault","item","commit","hasSubmitOnEnterValue","HTMLAnchorElement","click","textValue","value","hasHiddenTarget","hiddenTarget","dispatchEvent","Event","element","CustomEvent","bubbles","detail","Element","closest","once","fetchResults","identifyOptions","innerHTML","query","minLengthValue","hasUrlValue","url","URL","urlValue","window","location","href","params","URLSearchParams","search","slice","append","toString","fetch","then","response","text","html","open","catch","hasSkipHiddenPropertyValue","hidden","action","Controller","targets","values","submitOnEnter","Boolean","String","minLength","Number","skipHiddenProperty"],"mappings":"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"}